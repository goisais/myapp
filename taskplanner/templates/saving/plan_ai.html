{% extends "saving/base.html" %}
{% load static %}

{% block title %}プラン設計{% endblock %}
{% block header %}プラン設計{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'saving/plan_task.css' %}">
<link rel="stylesheet" href="{% static 'saving/plan_ai.css' %}">
{% endblock %}

{% block content %}

<div class="tab-menu">
    <a href="{% url 'plan_task' %}" class="tab">タスク追加</a>
    <a href="{% url 'plan_ai' %}" class="tab active">AI相談</a>
</div>

<div class="schedule-container">
    <h2>AI相談</h2>

    <details class="panel" {% if open_id %}open{% endif %}>
        <summary class="task-panel-summary" style="margin-top:20px;">
            登録済みタスク（{{ tasks|length }}）
            <span class="task-panel-hint">タップで開閉</span>
        </summary>

        {% for t in tasks %}
        <div class="schedule-item" id="task-{{ t.id }}">
            <b>{{ t.title }}</b><br>

            日時:
            {% if t.desired_at %}{{ t.desired_at|date:"m/d H:i" }}{% else %}未定{% endif %}<br>

            締切:
            {% if t.deadline %}{{ t.deadline|date:"m/d H:i" }}{% else %}未定{% endif %}<br>

            所要時間:
            {% if t.estimated_minutes %}{{ t.estimated_minutes }}分{% else %}未定{% endif %}
            /
            優先度: {{ t.get_priority_display }}

            {% if t.memo %}
            <div class="task-memo">{{ t.memo }}</div>
            {% endif %}

            <div class="task-actions">
                <a class="btn" href="{% url 'plan_task_edit' t.id %}">編集</a>

                <form method="post" action="{% url 'plan_task_delete' t.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button class="btn danger" type="submit" onclick="return confirm('削除しますか？');">削除</button>
                </form>
            </div>
        </div>
        {% empty %}
        <p>まだタスクがありません。</p>
        {% endfor %}
    </details>

    <form method="post" action="{% url 'plan_generate' %}">
        {% csrf_token %}
        <button class="submit-btn">AIに相談</button>
    </form>

    <h3 style="margin-top:20px;">AIの提案したプラン</h3>

    {% for s in suggestions %}
    <div class="ai-item">
        <div class="ai-time">
            {{ s.suggested_start|date:"m/d H:i" }} - {{ s.suggested_end|date:"H:i" }}
        </div>

        <div class="ai-title">{{ s.task.title }}</div>

        <div class="ai-duration">
            {% if s.task.estimated_minutes %}{{ s.task.estimated_minutes }}分{% else %}未設定{% endif %}
        </div>

        <div class="ai-priority priority-{{ s.task.priority }}">
            {{ s.task.get_priority_display }}
        </div>

        {% if s.task.memo %}
        <div class="ai-memo">{{ s.task.memo }}</div>
        {% endif %}

        <div class="ai-actions" style="margin-top:8px; display:flex; gap:8px;">
            <a href="{% url 'plan_suggestion_edit' s.id %}" class="btn">編集</a>

            <form method="post" action="{% url 'plan_suggestion_delete' s.id %}">
                {% csrf_token %}
                <button type="submit" class="btn danger" onclick="return confirm('この提案を削除しますか？');">
                    削除
                </button>
            </form>
        </div>
    </div>
    {% empty %}
    <p>まだ提案はありません。「AIに相談」を押してください。</p>
    {% endfor %}
    <form method="post" action="{% url 'plan_apply' %}">
        {% csrf_token %}
        <button class="submit-btn">カレンダーに登録</button>
    </form>
</div>

{% endblock %}